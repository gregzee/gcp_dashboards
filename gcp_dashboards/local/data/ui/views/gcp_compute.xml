<form>
  <search id="baseInstances">
    <query>|tstats dc(resource.data.id) as Count where `gcp_index` (sourcetype="google:gcp:assets" OR sourcetype=google:gcp:compute:instance) asset_type=compute.googleapis.com/Instance $text_search$ by _time, name, resource.data.name, resource.data.status, resource.data.id, resource.data.machineType, update_time 
       | eval projectid=replace(name,"\S+projects\/(\S+)\/zones\S+","\1") 
       |eval zone=replace(name,"\S+zones\/(\S+)\/instances\S+","\1")
    </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search base="baseInstances">
    <query>
       search projectid IN ($project_id_tok$) zone IN ($zone_tok$) 
       |dedup resource.data.id sortby -update_time
       |search resource.data.status="Running"
       |stats dc(resource.data.id) as count
    </query>
    <done>
      <set token="running_tok">$result.count$</set>
    </done>
  </search>
  <search base="baseInstances">
    <query> search  projectid IN ($project_id_tok$) zone IN ($zone_tok$)
|dedup resource.data.id sortby -update_time
|search resource.data.status="TERMINATED" 
    |stats count as count</query>
    <done>
      <set token="stopped_tok">$result.count$</set>
    </done>
  </search>
  <label>GCP Compute Engine Overview</label>
  <description>v1.6</description>
  <fieldset submitButton="false">
    <input type="time" token="time">
      <label>Timespan</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="multiselect" token="project_id_tok" searchWhenChanged="true">
      <label>Project ID</label>
      <choice value="*">ALL</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <delimiter> ,</delimiter>
      <fieldForLabel>Project_ID</fieldForLabel>
      <fieldForValue>Project_ID</fieldForValue>
      <search base="baseInstances">
        <query> |stats count by projectid |rename projectid as Project_ID</query>
      </search>
    </input>
    <input type="multiselect" token="zone_tok" searchWhenChanged="true">
      <label>Zone</label>
      <choice value="*">ALL</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <delimiter> </delimiter>
      <fieldForLabel>zone</fieldForLabel>
      <fieldForValue>zone</fieldForValue>
      <search base="baseInstances">
        <query> search projectid IN ($project_id_tok$)  | stats count by zone</query>
      </search>
    </input>
    <input type="text" token="text_search" searchWhenChanged="true">
      <label>Text Search (e.g. labels)</label>
      <default></default>
    </input>
  </fieldset>
  <row>
    <panel>
      <html>Usage note: a search time&gt;6hrs will potentially result in instances that no longer exist be displayed</html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Running Instances</title>
      <html>
        <center>
          <h1 style="background-color:MediumSeaGreen;">Running Instances: $running_tok$</h1>
          <h1 style="background-color:Tomato;"> Stopped Instances: $stopped_tok$</h1>
        </center>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Running Instances by Type</title>
      <chart>
        <search base="baseInstances">
          <query>search resource.data.status="Running"  projectid IN ($project_id_tok$) zone IN ($zone_tok$) | stats count by resource.data.id, resource.data.machineType | rename resource.data.machineType as mType | eval Type=replace(mType,"^\S+machineTypes\/(\S+)","\1") | stats count by Type</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Running Instances by Zones Over Time</title>
      <chart>
        <search base="baseInstances">
          <query>search resource.data.status="Running"  projectid IN ($project_id_tok$) zone IN ($zone_tok$) | timechart count by zone</query>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked100</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Operations</title>
      <chart>
        <search>
          <query>|tstats count where (index=gcp_json OR index=gcp) sourcetype="google:gcp:pubsub:message" "data.logName"="projects/*/logs/cloudaudit.googleapis.com%2Factivity" "data.resource.type"=gce_instance by _time, data.protoPayload.resourceName,data.protoPayload.methodName, data.protoPayload.response.operationType, data.resource.labels.project_id, data.resource.labels.zone
|rename data.protoPayload.methodName as methodName data.protoPayload.resourceName as name, data.resource.labels.project_id as projectid, data.resource.labels.zone as zone
          |search  projectid IN ($project_id_tok$) zone IN ($zone_tok$) 
|rename data.protoPayload.response.operationType as Action
|timechart count  by Action</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Instances</title>
      <table>
        <search base="baseInstances">
          <query>search projectid IN ($project_id_tok$) zone IN ($zone_tok$) 
|dedup resource.data.id sortby -update_time
          | rename resource.data.machineType as mType resource.data.id as "Instance ID"| eval Type=replace(mType,"^\S+machineTypes\/(\S+)","\1")
          | eval Name=replace(name,"^\S+instances\/(\S+)","\1")
          |table "Instance ID" , Name, projectid, zone, resource.data.status, Type, update_time
          |rename projectid as ProjectID, resource.data.status as "Last Known Status" update_time as "Last Update"</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">/app/gcp_dashboards/single_instance?form.selected_instance=$click.value$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <center>Click on one of the instances above to view detailed instance information</center>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Recent Activity / Users</title>
      <table>
        <search>
          <query>|tstats count where (index=gcp_json OR index=gcp) sourcetype="google:gcp:pubsub:message" "data.logName"="projects/*/logs/cloudaudit.googleapis.com%2Factivity" "data.resource.type"=gce_instance by _time, data.protoPayload.resourceName,data.protoPayload.methodName, data.protoPayload.response.operationType, data.protoPayload.response.user, data.resource.labels.project_id, data.resource.labels.zone
|rename data.protoPayload.methodName as methodName data.protoPayload.resourceName as Instance, data.protoPayload.response.operationType as Action, data.protoPayload.response.user as User  data.resource.labels.project_id as projectid, data.resource.labels.zone as zone
|search  projectid IN ($project_id_tok$) zone IN ($zone_tok$) 
|table _time, Instance, Action, User</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>